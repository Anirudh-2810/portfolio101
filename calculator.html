import React, { useState, useEffect } from 'react';
import { Delete, Divide, Minus, Plus, X } from 'lucide-react';

export default function Calculator() {
  const [display, setDisplay] = useState('0');
  const [previous, setPrevious] = useState('');
  const [operator, setOperator] = useState('');
  const [newNumber, setNewNumber] = useState(true);
  const [history, setHistory] = useState([]);

  useEffect(() => {
    const handleKeyPress = (e) => {
      if (e.key >= '0' && e.key <= '9') handleNumber(e.key);
      else if (e.key === '.') handleDecimal();
      else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') handleOperator(e.key);
      else if (e.key === 'Enter' || e.key === '=') handleEquals();
      else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') handleClear();
      else if (e.key === 'Backspace') handleBackspace();
    };
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [display, previous, operator, newNumber]);

  const handleNumber = (num) => {
    if (newNumber) {
      setDisplay(num);
      setNewNumber(false);
    } else {
      setDisplay(display === '0' ? num : display + num);
    }
  };

  const handleDecimal = () => {
    if (newNumber) {
      setDisplay('0.');
      setNewNumber(false);
    } else if (!display.includes('.')) {
      setDisplay(display + '.');
    }
  };

  const handleOperator = (op) => {
    if (previous && operator && !newNumber) {
      handleEquals();
    }
    setPrevious(display);
    setOperator(op);
    setNewNumber(true);
  };

  const handleEquals = () => {
    if (!previous || !operator) return;

    const prev = parseFloat(previous);
    const curr = parseFloat(display);
    let result;

    switch (operator) {
      case '+':
        result = prev + curr;
        break;
      case '-':
        result = prev - curr;
        break;
      case '*':
        result = prev * curr;
        break;
      case '/':
        if (curr === 0) {
          setDisplay('Error');
          setPrevious('');
          setOperator('');
          setNewNumber(true);
          return;
        }
        result = prev / curr;
        break;
      default:
        return;
    }

    const calculation = `${prev} ${operator} ${curr} = ${result}`;
    setHistory([calculation, ...history.slice(0, 4)]);
    setDisplay(result.toString());
    setPrevious('');
    setOperator('');
    setNewNumber(true);
  };

  const handleClear = () => {
    setDisplay('0');
    setPrevious('');
    setOperator('');
    setNewNumber(true);
  };

  const handleBackspace = () => {
    if (display.length === 1 || display === '0') {
      setDisplay('0');
    } else {
      setDisplay(display.slice(0, -1));
    }
  };

  const handlePercent = () => {
    setDisplay((parseFloat(display) / 100).toString());
  };

  const handleToggleSign = () => {
    setDisplay((parseFloat(display) * -1).toString());
  };

  const Button = ({ children, onClick, className = '', span = false }) => (
    <button
      onClick={onClick}
      className={`h-16 rounded-xl font-semibold text-lg transition-all duration-150 active:scale-95 ${
        span ? 'col-span-2' : ''
      } ${className}`}
    >
      {children}
    </button>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl p-6 border border-slate-700">
          {/* History */}
          {history.length > 0 && (
            <div className="mb-4 space-y-1 h-20 overflow-hidden">
              {history.map((calc, i) => (
                <div
                  key={i}
                  className="text-slate-400 text-xs font-mono text-right opacity-60"
                  style={{ opacity: 0.6 - i * 0.15 }}
                >
                  {calc}
                </div>
              ))}
            </div>
          )}

          {/* Display */}
          <div className="bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-6 mb-6 border border-slate-600">
            <div className="text-slate-400 text-sm mb-1 h-6 font-mono">
              {previous && operator && `${previous} ${operator}`}
            </div>
            <div className="text-white text-right text-4xl font-bold break-all">
              {display}
            </div>
          </div>

          {/* Buttons */}
          <div className="grid grid-cols-4 gap-3">
            <Button
              onClick={handleClear}
              className="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white shadow-lg shadow-red-500/30"
            >
              AC
            </Button>
            <Button
              onClick={handleBackspace}
              className="bg-gradient-to-br from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white"
            >
              <Delete className="w-5 h-5 mx-auto" />
            </Button>
            <Button
              onClick={handleToggleSign}
              className="bg-gradient-to-br from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white"
            >
              +/-
            </Button>
            <Button
              onClick={() => handleOperator('/')}
              className="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30"
            >
              <Divide className="w-5 h-5 mx-auto" />
            </Button>

            <Button
              onClick={() => handleNumber('7')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              7
            </Button>
            <Button
              onClick={() => handleNumber('8')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              8
            </Button>
            <Button
              onClick={() => handleNumber('9')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              9
            </Button>
            <Button
              onClick={() => handleOperator('*')}
              className="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30"
            >
              <X className="w-5 h-5 mx-auto" />
            </Button>

            <Button
              onClick={() => handleNumber('4')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              4
            </Button>
            <Button
              onClick={() => handleNumber('5')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              5
            </Button>
            <Button
              onClick={() => handleNumber('6')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              6
            </Button>
            <Button
              onClick={() => handleOperator('-')}
              className="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30"
            >
              <Minus className="w-5 h-5 mx-auto" />
            </Button>

            <Button
              onClick={() => handleNumber('1')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              1
            </Button>
            <Button
              onClick={() => handleNumber('2')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              2
            </Button>
            <Button
              onClick={() => handleNumber('3')}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              3
            </Button>
            <Button
              onClick={() => handleOperator('+')}
              className="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30"
            >
              <Plus className="w-5 h-5 mx-auto" />
            </Button>

            <Button
              onClick={() => handleNumber('0')}
              span
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              0
            </Button>
            <Button
              onClick={handleDecimal}
              className="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white"
            >
              .
            </Button>
            <Button
              onClick={handleEquals}
              className="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white shadow-lg shadow-green-500/30"
            >
              =
            </Button>
          </div>

          {/* Keyboard hint */}
          <div className="mt-4 text-center text-slate-500 text-xs">
            Keyboard supported: Numbers, operators, Enter, Escape, Backspace
          </div>
        </div>
      </div>
    </div>
  );
}